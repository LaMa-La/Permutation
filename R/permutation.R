#' Generate permutation of time labels
#'
#' @param seurat_analysis Seurat object
#' @param method Can be "longitudinal", "cross-sectional" that preserve the original structure of the data or "random" that might distort the data structure
#' @param donor.var Variable with unique donor identifiers
#' @param time.var Variable with time labels
#' @param remove.previous Remove previously generated permutations that contain the "perm" in the name
#' @param seed Set as many seeds as permutation rounds
#' @param perm_prefix Add a prefix to the permutation output column name
#' @param numeric Generates numeric version of the time labels needed for some DE tools as input. If default the output is generated by as.numeric() if custom then specify the function to get numeric output in numeric.function
#' @param numeric.function Specify the function to get numeric output of the time labels
#'
#' @return seurat object with the permuted time labels in the meta data
#'
#'
#' @export permutation
#'
#' @examples \dontrun{seurat_analysis <- permutation(seurat_analysis, method = "donor_longitudinal", numeric = "custom",
#' numeric.function = function(x){as.numeric(str_split(x, pattern =  "W", simplify = T)[,2])})}
#'
permutation <- function(seurat_analysis,
                        method = "longitudinal", #or "cross-sectional", "random"
                        donor.var = "PID",
                        time.var = "time", #can also be pseudotime
                        remove.previous = T,
                        seed = c(360, 90, 477, 26, 551),
                        perm_prefix = NULL,
                        numeric = "default",
                        numeric.function = NULL
){
  # Permutation that preserves donor structure

  if(remove.previous){
    ## Remove potential previous permutations
    m <- colnames(seurat_analysis@meta.data)[grep("perm",colnames(seurat_analysis@meta.data))]
    for (n in m){
      seurat_analysis[[n]] <- NULL
    }}

  #Loop through all seed
  for(i in 1:length(seed)){
    print(paste("Permutation round", i, sep=" "))


    data <- list()
    data_df <- data.frame()

    # generate Permutation method longitudinal
    if (method == "longitudinal"){
      for (p in unique(seurat_analysis@meta.data[,donor.var])){
        Seurat::Idents(seurat_analysis) <- donor.var
        tmp <- suppressMessages(subset(seurat_analysis, idents=p))
        set.seed(seed[i])
        data[[p]] <- sample(tmp@meta.data[,time.var])
        names(data[[p]]) <- NULL
        data_df <- rbind(data_df, data.frame("data" = data[[p]], "PID" = p))
      }
      # This is a super complicated way to make sure that the donors still match, which they did not fully do before
      data_df <- data_df[order(data_df$PID),]
      rownames(data_df) <- names(sort(seurat_analysis$PID))
      data_add <- data_df$data
      names(data_add) <- rownames(data_df)
      seurat_analysis <- Seurat::AddMetaData(seurat_analysis, data_add, col.name = paste0(perm_prefix,"perm", i))
      }

    # generate Permutation method cross-sectional
    if (method == "cross-sectional"){
      set.seed(seed[i])
      data <- sample(seurat_analysis@meta.data[,time.var], length(unique(seurat_analysis@meta.data[,donor.var])))
      names(data) <- unique(seurat_analysis@meta.data[,donor.var])

      #Here permutation is done on a donor level not cell level to ensure the donor structure is preserved
      seurat_analysis[[paste0(perm_prefix,"perm", i)]] <- data[seurat_analysis@meta.data[,donor.var]]
    }

    # generate Permutation method random
    if (method == "random"){
      set.seed(seed[i])
      data <- sample(seurat_analysis@meta.data[,time.var])
      names(data) <- NULL
      seurat_analysis[[paste0(perm_prefix,"perm", i)]] <- data
    }




    # generate other variables
    #Create the numeric version of the permuted time variable, adapt if necessary (output will be named perm1_num, perm2_num, ...)
    if(numeric == "default"){
      seurat_analysis[[paste0(perm_prefix,"perm", i, "_num")]] <- as.numeric(seurat_analysis@meta.data[,paste0(perm_prefix,"perm", i)])
    }
    if(numeric == "custom"){
      seurat_analysis[[paste0(perm_prefix,"perm", i, "_num")]] <- numeric.function(seurat_analysis@meta.data[,paste0(perm_prefix,"perm", i)])
    }

    #Donor permutation combinations needed for pseudobulk generation (output will be named PID_perm1, PID_perm2, ...)
    seurat_analysis[[paste0("PID_", "perm", i)]] <- paste(seurat_analysis$PID, seurat_analysis@meta.data[,paste0(perm_prefix,"perm", i)],sep="_")

    #Donor and numeric permutation combination (output will be named PID_perm1_num, PID_perm2_num, ...)
    seurat_analysis[[paste0("PID_", "perm", i, "_num")]] <- paste(seurat_analysis$PID, seurat_analysis@meta.data[,paste0(perm_prefix,"perm", i, "_num")] ,sep="_")
  }
  return(seurat_analysis)
}
